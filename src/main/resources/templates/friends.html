<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Friends</title>

    <link rel="stylesheet" th:href="@{/css/base.css}" />
    <link rel="stylesheet" th:href="@{/css/cards.css}" />
    <link rel="stylesheet" th:href="@{/css/nav.css}" />
    <link rel="stylesheet" th:href="@{/css/friends.css}" />
    <link rel="stylesheet" th:href="@{/css/footer.css}" />
</head>
<body>

<div th:replace="~{fragments/navbar :: navbar}"></div>

<main class="page-container friends-page"
      th:classappend="${activeTab}=='requests' ? ' is-requests' : ''">

    <header class="page-header">
        <h1>Friends & Requests</h1>

        <div class="segmented" role="tablist" aria-label="Friends view switch">
            <button type="button"
                    class="seg-btn"
                    data-tab="friends"
                    role="tab"
                    th:classappend="${activeTab}!='requests' ? ' is-active' : ''"
                    aria-selected="true">Friends</button>
            <button type="button"
                    class="seg-btn"
                    data-tab="requests"
                    role="tab"
                    th:classappend="${activeTab}=='requests' ? ' is-active' : ''"
                    aria-selected="false">Requests</button>
        </div>
    </header>

    <section class="panel friends-panel friends-section" aria-label="Your Friends">
        <h2 class="section-title">Your Friends</h2>
        <p class="muted" th:if="${friends == null or friends.isEmpty()}">No friends yet.</p>

        <div class="card" th:if="${friends != null and !friends.isEmpty()}">
            <div class="list">
                <div class="list-row list-row--friends" th:each="f : ${friends}">
                    <div class="name" th:text="${f.otherUserName}">Friend</div>

                    <div class="actions">
                        <form th:action="@{/friends/remove-by-username}"
                              method="post"
                              class="inline-form"
                              th:attr="data-confirm=|Remove ${f.otherUserName} from your friends?|">
                            <input type="hidden" name="username" th:value="${f.otherUserName}" />
                            <button type="submit" class="btn btn-danger">Remove</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="panel requests-panel friends-section" aria-label="Friend Requests">
        <h2 class="section-title">Send Friend Request</h2>

        <div class="cards-grid">
            <div class="card">
                <form th:action="@{/friends/send-by-username}" method="post" class="inline-form" autocomplete="off">
                    <label for="username" class="sr-only">Username</label>
                    <input type="text" id="username" name="username" placeholder="Enter username" required />
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>

        <h2 class="section-title" style="margin-top:1.25rem;">Incoming Requests</h2>
        <p class="muted" th:if="${incoming == null or incoming.isEmpty()}">No incoming requests.</p>
        <div class="card" th:if="${incoming != null and !incoming.isEmpty()}">
            <div class="list">
                <div class="list-row" th:each="req : ${incoming}">
                    <div class="name" th:text="${req.otherUserName}">Requester</div>
                    <div class="status-badge"
                         th:classappend="${req.status}=='PENDING' ? ' is-pending' :
                               (${req.status}=='ACCEPTED' ? ' is-accepted' : ' is-declined')"
                         th:text="${req.status}">PENDING</div>
                    <div class="actions">
                        <form th:action="@{/friends/accept-by-username}" method="post" class="inline-form">
                            <input type="hidden" name="username" th:value="${req.otherUserName}" />
                            <button type="submit" class="btn btn-primary">Accept</button>
                        </form>
                        <form th:action="@{/friends/decline-by-username}" method="post" class="inline-form">
                            <input type="hidden" name="username" th:value="${req.otherUserName}" />
                            <button type="submit" class="btn btn-danger">Decline</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <h2 class="section-title" style="margin-top:1.25rem;">Outgoing Requests</h2>
        <p class="muted" th:if="${outgoing == null or outgoing.isEmpty()}">No outgoing requests.</p>
        <div class="card" th:if="${outgoing != null and !outgoing.isEmpty()}">
            <div class="list">
                <div class="list-row" th:each="req : ${outgoing}">
                    <div class="name" th:text="${req.otherUserName}">Recipient</div>
                    <div class="status-badge"
                         th:classappend="${req.status}=='PENDING' ? ' is-pending' :
                               (${req.status}=='ACCEPTED' ? ' is-accepted' : ' is-declined')"
                         th:text="${req.status}">PENDING</div>
                    <div class="actions">
                        <form th:action="@{/friends/decline-by-username}" method="post" class="inline-form">
                            <input type="hidden" name="username" th:value="${req.otherUserName}" />
                            <button type="submit" class="btn btn-danger">Cancel</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
</main>

<div th:replace="~{fragments/footer :: footer}"></div>

<script>
    (function () {
        const root = document.querySelector('.friends-page');
        const btns = document.querySelectorAll('.segmented .seg-btn');
        btns.forEach(btn => btn.addEventListener('click', () => {
            const tab = btn.dataset.tab;
            root.classList.toggle('is-requests', tab === 'requests');
            btns.forEach(b => b.classList.toggle('is-active', b === btn));
            const url = new URL(window.location);
            url.searchParams.set('tab', tab);
            history.replaceState({}, '', url);
        }));
    })();
</script>

<script>
    (function () {
        const root = document.querySelector('.friends-page');
        const btns = document.querySelectorAll('.segmented .seg-btn');

        function setActive(tab){
            root.classList.toggle('is-requests', tab === 'requests');
            btns.forEach(b => {
                const active = b.dataset.tab === tab;
                b.classList.toggle('is-active', active);
                b.setAttribute('aria-selected', String(active));
            });
            const url = new URL(window.location);
            url.searchParams.set('tab', tab);
            history.replaceState({}, '', url);
        }

        btns.forEach(btn => btn.addEventListener('click', () => setActive(btn.dataset.tab)));

        setActive(root.classList.contains('is-requests') ? 'requests' : 'friends');

        document.addEventListener('submit', (e) => {
            const form = e.target.closest('form[data-confirm]');
            if (form && !confirm(form.getAttribute('data-confirm') || 'Are you sure?')) {
                e.preventDefault();
            }
        });
    })();
</script>


</body>
</html>
